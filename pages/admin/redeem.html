<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifikasi Tiket - Refresh Breeze Admin</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 1rem;
        }
        .redeem-card {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
        }
        .icon-box {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }
        .icon-box.loading { background: #e0f2fe; color: #0284c7; }
        .icon-box.success { background: #dcfce7; color: #16a34a; }
        .icon-box.error { background: #fee2e2; color: #dc2626; }
        
        h2 { margin-bottom: 0.5rem; color: #1f2937; }
        p { color: #6b7280; margin-bottom: 2rem; }
        
        .btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            background: #3b82f6;
            color: white;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="redeem-card">
        <div id="status-icon" class="icon-box loading">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <h2 id="status-title">Memverifikasi Tiket...</h2>
        <p id="status-desc">Mohon tunggu sebentar, sistem sedang mengecek status tiket.</p>
        
        <a href="../admin/index.html" class="btn">Kembali ke Admin</a>
    </div>

    <script src="../../js/shared/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('id');
            
            const iconBox = document.getElementById('status-icon');
            const title = document.getElementById('status-title');
            const desc = document.getElementById('status-desc');

            if (!orderId) {
                showError('Link tidak valid', 'ID Pesanan tidak ditemukan dalam URL.');
                return;
            }

            // Ambil token admin dari localStorage
            // Asumsi admin login di browser yang sama
            const token = localStorage.getItem('adminToken');
            if (!token) {
                showError('Akses Ditolak', 'Anda harus login sebagai Admin untuk memverifikasi tiket.');
                // Redirect ke login admin stlah 3 detik?
                setTimeout(() => window.location.href = '../auth/login.html', 3000);
                return;
            }

            try {
                const response = await fetch('/api/admin/redeem-ticket', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ orderId })
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess('Tiket Valid & Terpakai', result.message);
                } else {
                    showError('Gagal Verifikasi', result.message || 'Terjadi kesalahan server.');
                }
            } catch (error) {
                showError('Error Koneksi', 'Tidak dapat menghubungi server.');
            }

            function showSuccess(head, detail) {
                iconBox.className = 'icon-box success';
                iconBox.innerHTML = '<i class="fas fa-check"></i>';
                title.textContent = head;
                desc.textContent = detail;
            }

            function showError(head, detail) {
                iconBox.className = 'icon-box error';
                iconBox.innerHTML = '<i class="fas fa-times"></i>';
                title.textContent = head;
                desc.textContent = detail;
            }
        });
    </script>
</body>
</html>
